---
const { card } = Astro.props;

const media = card?.media ?? [];
const hasMedia = media.length > 0;
const isCarousel = media.length > 1;

// ✅ 카드별로 라벨 바꾸고 싶으면 notionLabel을 카드에 추가해서 쓰는 게 안전함
const notionLabel = card?.notionLabel ?? "상세 정보(Notion)";
---

<article class="fc">
    <header class="fc__header">
        <div>
            <h3 class="fc__title">{card.title}</h3>
            <p class="fc__summary">{card.summary}</p>
        </div>
    </header>

    {hasMedia ? (
            <div class="fc__mediaWrap" data-carousel={isCarousel ? "true" : "false"}>
                {isCarousel ? (
                        <>
                            <div class="fc__viewport" data-viewport>
                                {media.map((m) => (
                                        <div class="fc__slide" data-slide>
                                            {m.type === "video" ? (
                                                    <video
                                                            class="fc__mediaEl"
                                                            src={m.src}
                                                            controls
                                                            preload="metadata"
                                                            poster={m.poster || undefined}
                                                    />
                                            ) : (
                                                    <img class="fc__mediaEl" src={m.src} alt={m.alt || ""} loading="lazy" />
                                            )}
                                        </div>
                                ))}
                            </div>

                            <button class="fc__nav fc__prev" type="button" data-prev aria-label="이전">‹</button>
                            <button class="fc__nav fc__next" type="button" data-next aria-label="다음">›</button>

                            <div class="fc__dots">
                                {media.map((_, i) => (
                                        <button class="fc__dot" type="button" data-dot data-index={i} aria-label={`${i + 1}`} />
                                ))}
                            </div>
                            <script is:inline>
                                (() => {
                                    const script = document.currentScript;
                                    const root = script?.closest(".fc__mediaWrap");
                                    if (!root) return;

                                    if (root.getAttribute("data-carousel") !== "true") return;

                                    const viewport = root.querySelector("[data-viewport]");
                                    const dots = Array.from(root.querySelectorAll("[data-dot]"));
                                    const slides = Array.from(root.querySelectorAll("[data-slide]"));
                                    const prevBtn = root.querySelector("[data-prev]");
                                    const nextBtn = root.querySelector("[data-next]");

                                    if (!viewport || dots.length === 0 || slides.length === 0) return;

                                    const maxIndex = slides.length - 1;

                                    const pauseAllVideos = () => {
                                        root.querySelectorAll("video").forEach((v) => {
                                            try { v.pause(); } catch (e) {}
                                        });
                                    };

                                    const clamp = (i) => Math.min(Math.max(i, 0), maxIndex);

                                    const getIndex = () => {
                                        const w = viewport.clientWidth;
                                        if (!w) return 0;
                                        // ✅ 경계 튐을 줄이기 위해 약간 안정적으로 계산
                                        return Math.floor((viewport.scrollLeft + w * 0.5) / w);
                                    };

                                    const setDot = (i) => {
                                        dots.forEach((d, idx) => d.setAttribute("aria-current", idx === i ? "true" : "false"));
                                    };

                                    const updateNav = (i) => {
                                        if (!prevBtn || !nextBtn) return;
                                        prevBtn.toggleAttribute("disabled", i <= 0);
                                        nextBtn.toggleAttribute("disabled", i >= maxIndex);
                                    };

                                    const setUI = (i) => {
                                        const c = clamp(i);
                                        setDot(c);
                                        updateNav(c);
                                    };

                                    // ✅ 버튼 클릭 이동 중 UI 깜박임 방지용
                                    let isProgrammatic = false;
                                    let targetLeft = 0;
                                    let targetIndex = 0;
                                    let settleRaf = 0;

                                    const waitUntilSettled = () => {
                                        cancelAnimationFrame(settleRaf);

                                        const tick = () => {
                                            const diff = Math.abs(viewport.scrollLeft - targetLeft);

                                            // 2px 이내면 도착으로 간주 (환경 따라 1~4px 조절 가능)
                                            if (diff <= 2) {
                                                isProgrammatic = false;
                                                setUI(targetIndex);
                                                return;
                                            }
                                            settleRaf = requestAnimationFrame(tick);
                                        };

                                        settleRaf = requestAnimationFrame(tick);
                                    };

                                    const scrollToIndex = (i, behavior = "smooth") => {
                                        const w = viewport.clientWidth;
                                        if (!w) return;

                                        const c = clamp(i);
                                        pauseAllVideos();

                                        targetIndex = c;
                                        targetLeft = c * w;

                                        // ✅ 프로그램 이동 시작: 스크롤 중간값으로 UI 바꾸지 않게 잠금
                                        isProgrammatic = true;

                                        viewport.scrollTo({ left: targetLeft, behavior });

                                        // ✅ 도착했을 때만 UI 반영
                                        if (behavior === "auto") {
                                            isProgrammatic = false;
                                            setUI(c);
                                        } else {
                                            waitUntilSettled();
                                        }
                                    };

                                    // 초기
                                    setUI(0);

                                    // dot 클릭
                                    dots.forEach((d) => {
                                        d.addEventListener("click", () => {
                                            const i = Number(d.dataset.index || 0);
                                            scrollToIndex(i);
                                        });
                                    });

                                    // 버튼 (루프 없음)
                                    prevBtn?.addEventListener("click", () => scrollToIndex(getIndex() - 1));
                                    nextBtn?.addEventListener("click", () => scrollToIndex(getIndex() + 1));

                                    // 스와이프/스크롤 중 UI 업데이트
                                    let raf = 0;
                                    viewport.addEventListener("scroll", () => {
                                        if (isProgrammatic) return; // ✅ 버튼 이동 중엔 깜박임 방지
                                        cancelAnimationFrame(raf);
                                        raf = requestAnimationFrame(() => setUI(getIndex()));
                                    });

                                    // 리사이즈 시 현재 인덱스 유지
                                    window.addEventListener("resize", () => {
                                        const i = clamp(getIndex());
                                        scrollToIndex(i, "auto");
                                    });
                                })();
                            </script>
                        </>
                ) : (
                        <div class="fc__single">
                            {media[0].type === "video" ? (
                                    <video
                                            class="fc__mediaEl"
                                            src={media[0].src}
                                            controls
                                            preload="metadata"
                                            poster={media[0].poster || undefined}
                                    />
                            ) : (
                                    <img class="fc__mediaEl" src={media[0].src} alt={media[0].alt || ""} loading="lazy" />
                            )}
                        </div>
                )}
            </div>
    ) : null}

    {(card?.points?.length || card?.notionHref || card?.links?.length) ? (
            <div class="fc__details">
                {card?.points?.length ? (
                        <>
                            <div class="fc__detailsTitle">핵심 포인트</div>
                            <ul class="fc__list">
                                {card.points.map((p) => <li>{p}</li>)}
                            </ul>
                        </>
                ) : null}

                {card.notionHref ? (
                        <a class="chip" href={card.notionHref} target="_blank" rel="noreferrer">
                            {notionLabel}
                        </a>
                ) : null}

                {card.links?.map((l) => (
                        <a class="chip" href={l.href} target="_blank" rel="noreferrer" data-kind={l.kind}>
                            {l.label}
                        </a>
                ))}
            </div>
    ) : null}
</article>
